{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12 text-center mb-4">
        <h1 class="display-5 fw-bold">{{ trans('hero_title') }}</h1>
        <p class="lead text-muted">{{ trans('hero_subtitle') }}</p>
        <div class="d-flex justify-content-center gap-2">
            {% if not current_user.is_authenticated %}
                <a class="btn btn-success" href="{{ url_for('register') }}">{{ trans('hero_cta_public') }}</a>
                <a class="btn btn-outline-success" href="{{ url_for('register_shop') }}">{{ trans('hero_cta_shop') }}</a>
            {% else %}
                <a class="btn btn-success" href="#nearby-shops">{{ trans('hero_cta_view') }}</a>
                <a class="btn btn-outline-secondary" href="{{ url_for('orders') }}">{{ trans('hero_cta_orders') }}</a>
            {% endif %}
        </div>
    </div>
</div>

<!-- 地圖區塊 -->
<div class="row mb-5">
    <div class="col-12 position-relative">
        <button id="btn-my-location" class="btn btn-outline-danger btn-sm map-floating-btn">
            {{ trans('btn_my_location') }}
        </button>
        <div id="map" class="rounded shadow-sm" style="height: 400px; width: 100%;"></div>
    </div>
</div>

<!-- 商家列表區塊 -->
<div class="row" id="nearby-shops">
    <div class="col-12 mb-3">
        <h3>{{ trans('section_nearby') }}</h3>
    </div>
    
    {% for shop in shops %}
    <div class="col-md-4 mb-4">
        <div class="card h-100 border-0 shadow-sm shop-card" data-id="{{ shop.id }}" data-shop-index="{{ loop.index0 }}" data-quantity="{{ shop.available_quantity }}" data-lat="{{ shop.latitude or '' }}" data-lng="{{ shop.longitude or '' }}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">{{ shop.name }}</h5>
                    <div class="shop-badges"></div>
                </div>
                <div class="mb-2">
                    <button type="button"
                        class="btn btn-outline-secondary btn-sm btn-locate"
                        data-shop-id="{{ shop.id }}"
                        data-lat="{{ shop.latitude or '' }}"
                        data-lng="{{ shop.longitude or '' }}"
                        {% if not shop.latitude or not shop.longitude %}disabled{% endif %}>
                        {{ trans('btn_show_on_map') }}
                    </button>
                </div>
                <p class="card-text text-muted">
                    <i class="bi bi-geo-alt"></i> {{ shop.address }}<br>
                    <small>
                        {{ trans('label_opening_hours') }}:
                        {% if shop.opening_time %}{{ shop.opening_time.strftime('%H:%M') }}{% else %}--{% endif %} -
                        {% if shop.closing_time %}{{ shop.closing_time.strftime('%H:%M') }}{% else %}--{% endif %}
                    </small>
                </p>
                <p class="card-text">
                    {{ trans('label_remaining') }}:
                    {% if shop.available_quantity > 0 %}
                        <span class="badge bg-success">{{ shop.available_quantity }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ trans('label_sold_out') }}</span>
                    {% endif %}
                </p>
                
                <a href="{{ url_for('shop_detail', shop_id=shop.id) }}" class="btn btn-primary w-100 {% if shop.available_quantity <= 0 %}disabled{% endif %}">
                    {% if shop.available_quantity > 0 %}{{ trans('label_view_details') }}{% else %}{{ trans('label_sold_out') }}{% endif %}
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- 將商家資料傳遞給 JS 以繪製地圖 -->
<script>
    var userLocationLabel = {{ trans('map_user_location')|tojson }};
    var badgeLabels = {
        most: {{ trans('badge_most_supply')|tojson }},
        nearest: {{ trans('badge_nearest')|tojson }}
    };
    var shopData = [
        {% for shop in shops %}
        {
            id: {{ shop.id }},
            name: "{{ shop.name }}",
            lat: {{ shop.latitude or 0 }},
            lng: {{ shop.longitude or 0 }},
            address: "{{ shop.address }}",
            food_count: {{ shop.available_quantity }}
        },
        {% endfor %}
    ];
    var transRemaining = {{ trans('label_remaining')|tojson }};
</script>
{% endblock %}
